set -eux

source /var/vcap/packages/golang-1.12-linux/bosh/compile.env

mkdir ${BOSH_COMPILE_TARGET}/src
mv ${BOSH_COMPILE_TARGET}/docker-registry-certs ${BOSH_COMPILE_TARGET}/src/docker-registry-certs

export GOPATH=${BOSH_COMPILE_TARGET}

# Run unit tests
pushd ${BOSH_COMPILE_TARGET}/src/docker-registry-certs
go test ./...

# Create the executable file
mkdir -p ${BOSH_INSTALL_TARGET}/bin
go build -o ${BOSH_INSTALL_TARGET}/bin/generate_certs ${BOSH_COMPILE_TARGET}/src/docker-registry-certs/main.go
